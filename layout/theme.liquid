<!doctype html>
<html lang="{{ request.locale.iso_code }}">
  <style>
  /* Prevents clicks from being intercepted by the + or - text/icons */
  .cart-drawer-item button {
    pointer-events: all !important;
    z-index: 10;
  }
  .cart-drawer-item button * {
    pointer-events: none;
  }
</style>

  <head>
    {% # Inlined CSS Variables %}
    {% render 'css-variables' %}

    {% comment %}
      Font preloading:
      1. Preconnect to font CDN for faster connection
      2. Preload only the critical font variant (base weight)
      3. Additional variants load on-demand via @font-face
    {% endcomment %}
    {% unless settings.type_primary_font.system? %}
      <link rel="preconnect" href="https://fonts.shopifycdn.com" crossorigin>

      {% comment %} Preload the base font variant for initial page render {% endcomment %}
      {{ settings.type_primary_font | font_url | preload_tag: as: 'font', crossorigin: 'anonymous' }}
    {% endunless %}

    {% # Load and preload the critical CSS %}
    {{ 'critical.css' | asset_url | stylesheet_tag: preload: true }}

    {% # Social, title, etc. %}
    {% render 'meta-tags' %}

    {{ content_for_header }}
  </head>

  <body class="gradient">
  <header class="site-frame-header">
    {% section 'header' %}
  </header>

  <main id="MainContent" class="content-for-layout focus-none" role="main" tabindex="-1">
    {{ content_for_layout }}
  </main>

  <footer class="site-frame-footer">
    {% section 'footer' %}
  </footer>

  {% section 'cart-drawer' %}

  {% comment %} 
    Removed missing scroll-reveal.js call to prevent console errors 
    that break cart functionality.
  {% endcomment %}



 <script>
  document.addEventListener('submit', function(e) {
    if (e.target.matches('[action="/cart/add"]')) {
      e.preventDefault();
      
      const form = e.target;
      const formData = new FormData(form);
      const submitBtn = form.querySelector('[type="submit"]');
      if (submitBtn) submitBtn.style.opacity = '0.7';

      fetch('/cart/add.js', {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(item => {
        if (window.updateCartCountBubble) window.updateCartCountBubble();

        if (window.refreshDrawer) {
          window.refreshDrawer().then(() => {
            if (window.toggleCart) window.toggleCart();
          });
        } else {
          if (window.toggleCart) window.toggleCart();
        }
      })
      .catch(error => console.error('Add to Cart Error:', error))
      .finally(() => {
        if (submitBtn) submitBtn.style.opacity = '1';
      });
    }
  });

  window.updateCartCountBubble = function() {
    fetch('/cart.js')
      .then(res => res.json())
      .then(cart => {
        const bubble = document.querySelector('.cart-count-number');
        if (bubble) {
          bubble.textContent = cart.item_count;
          bubble.style.display = cart.item_count > 0 ? 'flex' : 'none';
        }
      });
  };
</script>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    const observerOptions = { threshold: 0.1 };
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.classList.add('is-visible');
        }
      });
    }, observerOptions);

    // Apply to all product cards and section headings
    document.querySelectorAll('.studio-product-card, .section-heading').forEach(el => {
      el.classList.add('animate-on-scroll');
      observer.observe(el);
    });
  });
</script>

<script>
  function selectGridVariant(button, productId) {
  // 1. Prevent the link click (don't go to product page)
  event.preventDefault();
  event.stopPropagation();

  // 2. Get Data
  const card = button.closest('.studio-product-card');
  const variantId = button.getAttribute('data-variant-id');
  const price = button.getAttribute('data-variant-price');
  const available = button.getAttribute('data-variant-available') === 'true';
  const newImage = button.getAttribute('data-variant-image');

  // 3. Update Visuals (Pills)
  card.querySelectorAll('.variant-pill').forEach(btn => {
    btn.style.background = '#fff';
    btn.style.color = '#800000';
    btn.style.borderColor = '#ddd';
  });
  button.style.background = '#800000';
  button.style.color = '#fff';
  button.style.borderColor = '#800000';

  // 4. Update Inputs
  const input = card.querySelector('.selected-variant-id');
  if(input) input.value = variantId;

  // 5. Update Price
  const priceDisplay = card.querySelector('.product-price');
  if(priceDisplay) priceDisplay.innerText = price;

  // 6. Update Add to Bag Button
  const addBtn = card.querySelector('.quick-add-btn');
  if (addBtn) {
    if (available) {
      addBtn.disabled = false;
      addBtn.innerText = 'ADD TO BAG';
      addBtn.classList.remove('disabled');
    } else {
      addBtn.disabled = true;
      addBtn.innerText = 'SOLD OUT';
      addBtn.classList.add('disabled');
    }
  }

  // 7. Update Image - Now with a safety check
  const mainImg = card.querySelector('.grid-img');
  if (mainImg && newImage && newImage !== "null" && !newImage.includes('Liquid error')) {
    mainImg.src = newImage;
  } else {
    console.log("Image Lock: No valid variant image found, keeping original.");
  }
}
</script>

{% comment %} custom-scripts.js is now empty/safe, keeping for future UI tweaks {% endcomment %}
<script src="{{ 'custom-scripts.js' | asset_url }}" defer="defer"></script>

 {% comment %} Custom ArtShop Logic {% endcomment %}
    <script src="{{ 'custom-scripts.js' | asset_url }}" defer="defer"></script>
  </body>
</html>

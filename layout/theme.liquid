<!doctype html>
<html lang="{{ request.locale.iso_code }}">
  <head>
    {% # Inlined CSS Variables %}
    {% render 'css-variables' %}

    {% comment %}
      Font preloading:
      1. Preconnect to font CDN for faster connection
      2. Preload only the critical font variant (base weight)
      3. Additional variants load on-demand via @font-face
    {% endcomment %}
    {% unless settings.type_primary_font.system? %}
      <link rel="preconnect" href="https://fonts.shopifycdn.com" crossorigin>

      {% comment %} Preload the base font variant for initial page render {% endcomment %}
      {{ settings.type_primary_font | font_url | preload_tag: as: 'font', crossorigin: 'anonymous' }}
    {% endunless %}

    {% # Load and preload the critical CSS %}
    {{ 'critical.css' | asset_url | stylesheet_tag: preload: true }}

    {% # Social, title, etc. %}
    {% render 'meta-tags' %}

    {{ content_for_header }}
  </head>

  <body class="gradient">
  <header class="site-frame-header">
    {% section 'header' %}
  </header>

  <main id="MainContent" class="content-for-layout focus-none" role="main" tabindex="-1">
    {{ content_for_layout }}
  </main>

  <footer class="site-frame-footer">
    {% section 'footer' %}
  </footer>

  {% comment %} 
    The Cart Drawer section is the "Master" container. 
    It contains its own HTML, CSS, and Logic to prevent theme.liquid from getting cluttered.
  {% endcomment %}
  {% section 'cart-drawer' %}

  <script src="{{ 'scroll-reveal.js' | asset_url }}" defer></script>

 <script>
  document.addEventListener('submit', function(e) {
    if (e.target.matches('[action="/cart/add"]')) {
      e.preventDefault();
      
      const form = e.target;
      const formData = new FormData(form);

      // Visual feedback: dim the button
      const submitBtn = form.querySelector('[type="submit"]');
      if (submitBtn) submitBtn.style.opacity = '0.7';

      fetch('/cart/add.js', {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(item => {
        // Update the header count immediately
        if (window.updateCartCountBubble) {
          window.updateCartCountBubble();
        }

        // CRITICAL FIX: Wait for the refresh to finish BEFORE opening the drawer
        if (window.refreshDrawer) {
          window.refreshDrawer().then(() => {
            // Only open AFTER the new images are in the DOM
            if (window.toggleCart) window.toggleCart();
          });
        } else {
          // Fallback if function is missing
          if (window.toggleCart) window.toggleCart();
        }
      })
      .catch(error => console.error('Add to Cart Error:', error))
      .finally(() => {
        if (submitBtn) submitBtn.style.opacity = '1';
      });
    }
  });

  // Ensure this function exists and targets your specific bubble class
  window.updateCartCountBubble = function() {
    fetch('/cart.js')
      .then(res => res.json())
      .then(cart => {
        const bubble = document.querySelector('.cart-count-number');
        if (bubble) {
          bubble.textContent = cart.item_count;
          bubble.style.display = cart.item_count > 0 ? 'flex' : 'none';
        }
      });
  };
</script>

  </body>
</html>


